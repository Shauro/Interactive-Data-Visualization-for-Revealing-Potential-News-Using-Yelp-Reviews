<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.6/d3.min.js" charset="utf-8"></script><!--import D3-->
    <script src="jquery-2.1.4.js"></script>
    <script src="elasticsearch.jquery.js"></script>
    <script src="elasticsearch.jquery.min.js"></script>
    <script src="es_yelp.js"></script>
    <style>
        div {
            display: inline-block;
            margin-left: 10px;
        }
    </style>
</head>
<body>
    <div id="desc">
        <p>Max Increase Review Amount -> Business Name(Top 10)</p>
    </div>
    <div id="desc2">
        <p>Max Increase Review Amount -> Business Name(Next Page, 10 to 20)</p>
    </div>
    <p>=================================</p>
    <div id="asc">
        <p>Max Decrease Review Amount -> Business Name(Top 10)</p>
    </div>
    <div id="asc2">
        <p>Max Decrease Review Amount -> Business Name(Top 10)</p>
    </div>
    <script type="text/javascript">
        var client = new $.es.Client({
            host: 'http://localhost:9200'
        });
        client.ping({
            requestTimeout: 30000 // undocumented params are appended to the query string
        }, function (error) {
            if (error) {
                console.error('elasticsearch cluster is down!');
            } else {
                console.log('All is well');
            }
        });
        data_search();
        function data_search() {
            client.search({
                "index": "yelp",
                "q": "business_id: *",
                //"q": "business_id: 1bMesJDIAG9GpRU1SwKMsg",
                "size": 10
                //"sort": ["max_diff_review_amount:desc", "max_diff_stars:desc"]
            }, function (error, business_list) {
                console.log(business_list["hits"]["hits"]);
                //console.log(business_list["hits"]["hits"][0]["_source"]);
                d3.select("#desc").selectAll("li")
                        .data(business_list["hits"]["hits"])
                        .enter().append("li")
                        .text(function(d){return d["_source"]["max_diff_review_amount"] + "->" +d["_source"]["name"]});
                var ret = rank_business_list_in_time_interval(business_list["hits"]["hits"], "2013-12-30", "2014-12-30", 7);
                console.log(ret);
            });
        }
    function rank_business_list_in_time_interval(business_array, start_date, end_date, time_interval) {
        var len = business_array.length;
        var i = 0;
        var business_ranking_max_diff_review_amount = new Array(len);
        business_ranking_max_diff_review_amount.fill(0);
        var business_ranking_max_diff_stars = new Array(len);
        business_ranking_max_diff_stars.fill(0);
        while (i < len) {
            var sum_array = sum_one_business_review_stars_in_time_interval(business_array[i], start_date, end_date, time_interval);
            var max_diff_array = calculate_one_business_max_diff_review_stars_in_time_interval(sum_array[0], sum_array[1]);
            business_ranking_max_diff_review_amount[i] = createPair(max_diff_array[0], business_array[i]["_source"]["business_id"]);
            business_ranking_max_diff_stars[i] = createPair(max_diff_array[1], business_array[i]["_source"]["business_id"]);
            i++;
        }
        business_ranking_max_diff_review_amount.sort(comparePairAscend);
        business_ranking_max_diff_stars.sort(comparePairAscend);
        return [business_ranking_max_diff_review_amount, business_ranking_max_diff_stars];
    }
    function comparePairAscend(pair1, pair2) {
        if (pair1.number <= pair2.number) {
            return 1;
        } else {
            return -1;
        }
    }
    function createPair(amount, business_id) {
        var pair = Object.create(Pair);
        pair.number = amount;
        pair.business_id = business_id;
        return pair;
    }
    var Pair = {
        number: 0,
        business_id: 0
    };
    function calculate_one_business_max_diff_review_stars_in_time_interval(sum_review_amount_array, sum_stars_array) {
        var len = sum_review_amount_array.length;
        var max_diff_review_amount = 0;
        var max_diff_stars = 0;
        var i = 1;
        while (i < len) {
            var diff_review_amount = sum_review_amount_array[i] - sum_review_amount_array[i - 1];
            if (Math.abs(max_diff_review_amount) < diff_review_amount) {
                max_diff_review_amount = diff_review_amount;
            }
            var diff_stars_avg = sum_stars_array[i] / sum_review_amount_array[i] -
                    sum_stars_array[i - 1] / sum_review_amount_array[i - 1];
            if (Math.abs(max_diff_stars) < diff_stars_avg) {
                max_diff_stars = diff_stars_avg;
            }
            i++;
        }
        return [max_diff_review_amount, max_diff_stars];
    }
    function sum_one_business_review_stars_in_time_interval(business, start_date, end_date, time_interval) {
        var start_seconds = Date.parse(start_date);
        var end_seconds = Date.parse(end_date);
        var interval_seconds = time_interval * 24 * 3600 * 1000;
        var len = Math.floor((end_seconds - start_seconds)/interval_seconds);//ignore dates not enough for interval
        var new_start_seconds = start_seconds + (end_seconds - start_seconds) % interval_seconds;
        var sum_review_amount_array = new Array(len);
        sum_review_amount_array.fill(0);
        var sum_stars_array = new Array(len);
        sum_stars_array.fill(0);
        $.each(business["_source"]["stars_reviews"], function(date) {
            var seconds = Date.parse(date);
            if (seconds > new_start_seconds && seconds < end_seconds) {
                var amount = business["_source"]["stars_reviews"][date]["review_amount"];
                var stars = business["_source"]["stars_reviews"][date]["stars"];
                var pos = Math.floor((seconds - new_start_seconds)/interval_seconds);
                sum_review_amount_array[pos] += amount;
                sum_stars_array[pos] += stars;
            }
        });
        return [sum_review_amount_array, sum_stars_array];
    }
    function load_file_and_bulk_create(source_file_name) {
        d3.text(source_file_name, function(result){
            bulk_create(client, result);
        });
    }
    function bulk_create(json_array) {
        var temp = JSON.parse(json_array);
        client.bulk({
            body: temp
        });
    }
    </script>
</body>
</html>
